<template>
  <div ref="container" class="float-top-down-marker" @click="onClick">
    <svg
      id="float-top-down"
      xmlns:dc="http://purl.org/dc/elements/1.1/"
      xmlns:cc="http://creativecommons.org/ns#"
      xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
      xmlns:svg="http://www.w3.org/2000/svg"
      xmlns="http://www.w3.org/2000/svg"
      version="1.1"
      viewBox="0 0 33.866666 33.866666"
      :height="scaledHeight"
      :width="scaledWidth"
    >
      <g>
        <rect
          ry="0.47624516"
          rx="0.44097206"
          y="2.1166663"
          x="11.641667"
          height="4.7625003"
          width="2.6458323"
          id="wheel-3-9"
          style="
            opacity: 1;
            fill: #000000;
            fill-opacity: 1;
            stroke: none;
            stroke-width: 0.21561684;
            stroke-linecap: butt;
            stroke-linejoin: round;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
            paint-order: normal;
          "
        />
        <rect
          ry="0.47624522"
          rx="0.44097206"
          y="2.1166651"
          x="19.579166"
          height="4.7625008"
          width="2.6458323"
          id="wheel-4-9"
          style="
            opacity: 1;
            fill: #000000;
            fill-opacity: 1;
            stroke: none;
            stroke-width: 0.21561685;
            stroke-linecap: butt;
            stroke-linejoin: round;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
            paint-order: normal;
          "
        />
        <rect
          ry="0.58207756"
          rx="0.44097206"
          y="25.929167"
          x="22.225004"
          height="5.8208337"
          width="2.6458323"
          id="wheel-1"
          style="
            opacity: 1;
            fill: #000000;
            fill-opacity: 1;
            stroke: none;
            stroke-width: 0.23837338;
            stroke-linecap: butt;
            stroke-linejoin: round;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
            paint-order: normal;
          "
        />
        <rect
          ry="0.5820775"
          rx="0.44097206"
          y="25.929167"
          x="8.9958372"
          height="5.8208337"
          width="2.6458323"
          id="wheel-2"
          style="
            opacity: 1;
            fill: #000000;
            fill-opacity: 1;
            stroke: none;
            stroke-width: 0.23837338;
            stroke-linecap: butt;
            stroke-linejoin: round;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
            paint-order: normal;
          "
        />
        <path
          id="bucket"
          d="m 10.583333,17.727083 v 3.439583 10.583333 h 4.233333 l 0,-2.116666 c 4.233334,0 0,0 4.233334,0 l 0,2.116666 h 4.233333 V 21.166666 17.727083 c -3.175,-3.439583 0,0.264583 -3.175,-3.439583 h -3.175 -3.175 c -3.175,3.704166 0,0 -3.175,3.439583 z"
          style="
            fill: #e8ba00;
            fill-opacity: 1;
            stroke: #000000;
            stroke-width: 0.34642091px;
            stroke-linecap: butt;
            stroke-linejoin: miter;
            stroke-opacity: 1;
          "
        />
        <rect
          ry="0.47624516"
          rx="0.44097206"
          y="8.4666662"
          x="11.64167"
          height="4.7625003"
          width="2.6458323"
          id="wheel-3"
          style="
            opacity: 1;
            fill: #000000;
            fill-opacity: 1;
            stroke: none;
            stroke-width: 0.21561684;
            stroke-linecap: butt;
            stroke-linejoin: round;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
            paint-order: normal;
          "
        />
        <rect
          ry="0.47624522"
          rx="0.44097206"
          y="8.4666662"
          x="19.57917"
          height="4.7625008"
          width="2.6458323"
          id="wheel-4"
          style="
            opacity: 1;
            fill: #000000;
            fill-opacity: 1;
            stroke: none;
            stroke-width: 0.21561685;
            stroke-linecap: butt;
            stroke-linejoin: round;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
            paint-order: normal;
          "
        />
        <path
          id="tractor-body"
          d="M 15.240001,1.5874997 V 2.6458331 L 12.7,3.7041664 v 4.7624999 h 0.846666 v 4.7624997 h 1.693335 v -2.645833 h 3.386664 v 2.645833 h 1.693334 V 8.4666663 h 0.846667 V 3.7041664 L 18.626665,2.6458331 V 1.5874997 Z"
          style="
            fill: #e8ba00;
            fill-opacity: 1;
            stroke: #000000;
            stroke-width: 0.33467433px;
            stroke-linecap: butt;
            stroke-linejoin: miter;
            stroke-opacity: 1;
          "
        />
        <rect
          ry="0"
          rx="0"
          y="9.5250006"
          x="15.874998"
          height="5.291666"
          width="2.1166673"
          id="bucket-arm"
          style="
            opacity: 1;
            fill: #e8ba00;
            fill-opacity: 1;
            stroke: #000000;
            stroke-width: 0.42084101;
            stroke-linecap: butt;
            stroke-linejoin: round;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
            paint-order: normal;
          "
        />
        <path
          id="cabin"
          d="M 14.2875,8.4666663 V 4.2994788 L 15.875,3.7041663 h 2.116666 l 1.587501,0.5953125 v 4.1671875 z"
          style="
            fill: #666666;
            stroke: #000000;
            stroke-width: 0.280633px;
            stroke-linecap: butt;
            stroke-linejoin: miter;
            stroke-opacity: 1;
          "
        />
        <rect
          ry="0.58207744"
          rx="0.44097206"
          y="25.929167"
          x="6.3500009"
          height="5.8208337"
          width="2.6458323"
          id="wheel-2-4"
          style="
            opacity: 1;
            fill: #000000;
            fill-opacity: 1;
            stroke: none;
            stroke-width: 0.23837338;
            stroke-linecap: butt;
            stroke-linejoin: round;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
            paint-order: normal;
          "
        />
        <rect
          ry="0.5820775"
          rx="0.44097206"
          y="25.929165"
          x="24.87084"
          height="5.8208337"
          width="2.6458323"
          id="wheel-1-3"
          style="
            opacity: 1;
            fill: #000000;
            fill-opacity: 1;
            stroke: none;
            stroke-width: 0.23837338;
            stroke-linecap: butt;
            stroke-linejoin: round;
            stroke-miterlimit: 4;
            stroke-dasharray: none;
            stroke-opacity: 1;
            paint-order: normal;
          "
        />
      </g>
    </svg>
  </div>
</template>

<script>
const COLORS = {
  yellow: '#ffcc00',
  darkYellow: '#aa8800',
};

const DEFAULT_COLORS = {
  wheels: { color: 'black' },
  frontBar: { fillColor: COLORS.yellow },
  radiator: { fillColor: COLORS.yellow },
  head: { fillColor: COLORS.yellow, strokeColor: COLORS.darkYellow },
  tray: { fillColor: COLORS.yellow, strokeColor: COLORS.darkYellow },
  trayInlay: { fillColor: COLORS.darkYellow },
  lightPoles: { fillColor: COLORS.yellow },
  lights: { fillColor: 'grey' },
};

const DEFAULT_ORIGIN = {
  x: 0.5,
  y: 0.5,
};

function getOpts(map) {
  return {
    stroke: map.strokeColor || map.color,
    fill: map.fillColor || map.color,
    'stroke-opacity': map.strokeOpacity || map.opacity || 1,
    'fill-opacity': map.fillOpacity || map.opacity || 1,
  };
}

function mergeColors(defaultColors, colors = {}) {
  const cols = {};
  Object.keys(defaultColors).forEach(attrib => {
    cols[attrib] = { ...defaultColors[attrib], ...(colors[attrib] || {}) };
  });
  return cols;
}

export default {
  name: 'FloatTopDownMarker',
  props: {
    scale: { type: Number, default: 1 },
    colors: { type: Object, default: () => ({}) },
    origin: { type: Object, default: () => DEFAULT_ORIGIN },
    rotationOrigin: { type: Object, default: null },
    rotation: { type: Number, default: 0 },
  },
  data: () => {
    return {
      width: 128,
      height: 128,
      baseScale: 0.5,
    };
  },
  computed: {
    scaledWidth() {
      return this.width * this.scale * this.baseScale;
    },
    scaledHeight() {
      return this.height * this.scale * this.baseScale;
    },
  },
  watch: {
    origin() {
      this.setTranslation();
    },
    rotationOrigin() {
      this.setTranslation();
    },
    scale() {
      this.setTranslation();
    },
    rotation() {
      this.setTranslation();
    },
  },
  mounted() {
    this.setTranslation();
  },
  methods: {
    onClick() {
      this.$emit('click');
    },
    getStyle(id) {
      const colors = mergeColors(DEFAULT_COLORS, this.colors);
      const opts = getOpts(colors[id] || {});
      return Object.entries(opts)
        .map(([key, value]) => `${key}:${value}`)
        .join(';');
    },
    setTranslation() {
      const container = this.$refs.container;

      // calculate the rotation origin
      const rotationOrigin = this.rotationOrigin || this.origin;
      const xO = rotationOrigin.x;
      const yO = rotationOrigin.y;
      const transformOrigin = `${xO * 100}% ${yO * 100}%`;

      const transform = `rotate(${this.rotation}deg)`;

      container.style.transform = transform;
      container.style.transformOrigin = transformOrigin;
    },
  },
};
</script>

<style>
.float-top-down-marker {
  cursor: pointer;
}
</style>
