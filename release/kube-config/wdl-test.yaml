apiVersion: v1
kind: Service
metadata:
  name: fleet-control-ui-subdomain
  namespace: wdl-test
spec:
  ports:
    - port: 80
      protocol: TCP
      targetPort: 4001
  selector:
    app: fleet-control-ui
    subdomain: fleet-control-ui
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fleet-control-ui.deployment
  namespace: wdl-test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fleet-control-ui
  template:
    metadata:
      labels:
        app: fleet-control-ui
        subdomain: fleet-control-ui
    spec:
      hostname: fleet-control-ui
      subdomain: fleet-control-ui-subdomain
      containers:
        - name: fleet-control-ui
          image: hxreg.azurecr.io/fleet-control-ui
          imagePullPolicy: "Always"
          env:
            - name: APPSIGNAL_APP_NAME
              value: fleet_control_ui_kube-wdl-test
            - name: APPSIGNAL_APP_ENV
              value: prod
            - name: APPSIGNAL_API
              valueFrom:
                secretKeyRef:
                  name: secrets
                  key: APPSIGNAL_PUSH_API_KEY
            - name: SLACK_LOGGER_WEBHOOK_URL 
              valueFrom:
                secretKeyRef:
                  name: secrets
                  key: SLACK_LOGGER_WEBHOOK_URL 
            - name: AZURE_ACTIVE_DIRECTORY
              valueFrom:
                secretKeyRef:
                  name: secrets
                  key: AZURE_ACTIVE_DIRECTORY
            - name: MAP_KEY
              valueFrom:
                secretKeyRef:
                  name: secrets
                  key: MAP_KEY
            - name: HPSSQL_CONNECTION
              valueFrom:
                secretKeyRef:
                  name: secrets
                  key: HPSSQL_CONNECTION
            - name: HPSSQL_ENCRYPTION_KEY
              valueFrom:
                secretKeyRef:
                  name: secrets
                  key: HPSSQL_ENCRYPTION_KEY
            - name: GPS_GATE_REST
              valueFrom:
                secretKeyRef:
                  name: secrets
                  key: GPS_GATE_REST
            - name: DISPATCH_JOKEN_SECRET
              valueFrom:
                secretKeyRef:
                  name: secrets
                  key: DISPATCH_JOKEN_SECRET
            - name: SLACK_WEBHOOK
              valueFrom:
                secretKeyRef:
                  name: secrets
                  key: SLACK_WEBHOOK
            - name: RELEASE_COOKIE
              valueFrom:
                secretKeyRef:
                  name: secrets
                  key: RELEASE_COOKIE
            - name: RELEASE_DISTRIBUTION
              value: name
            - name: RELEASE_NODE
              value: fleet-control-ui@fleet-control-ui.fleet-control-ui-subdomain
            - name: DISPATCH
              value: |
                [
                  quick_messages: [
                    "Smoko after tip",
                    "Blasting about to start",
                    ["Did you get this message", "Yes", "No"]
                  ],
                  track_method: :gps_gate,
                  permissions: [
                    authorized: ["c42c1c30-fbed-4846-a522-5b1c2bfbea53"],
                    can_dispatch: ["c42c1c30-fbed-4846-a522-5b1c2bfbea53"],
                    can_edit_devices: ["c42c1c30-fbed-4846-a522-5b1c2bfbea53"],
                    can_edit_operators: ["c42c1c30-fbed-4846-a522-5b1c2bfbea53"], 
                    can_edit_time_allocations: ["c42c1c30-fbed-4846-a522-5b1c2bfbea53"], 
                    can_lock_time_allocations: ["c42c1c30-fbed-4846-a522-5b1c2bfbea53"], 
                    can_edit_time_codes: ["c42c1c30-fbed-4846-a522-5b1c2bfbea53"], 
                    can_edit_messages: ["c42c1c30-fbed-4846-a522-5b1c2bfbea53"], 
                    can_refresh_agents: ["c42c1c30-fbed-4846-a522-5b1c2bfbea53"], 
                    can_edit_routing: ["c42c1c30-fbed-4846-a522-5b1c2bfbea53"], 
                    can_edit_pre_starts: ["c42c1c30-fbed-4846-a522-5b1c2bfbea53"],
                    can_edit_pre_start_tickets: ["c42c1c30-fbed-4846-a522-5b1c2bfbea53"],
                    can_edit_asset_roster: ["c42c1c30-fbed-4846-a522-5b1c2bfbea53"]
                  ],
                  settings: [
                    use_device_gps: false,
                    prompt_exception_on_logout: true,
                    prompt_engine_hours_on_login: true,
                    prompt_engine_hours_on_logout: false,
                    prompt_pre_starts_on_login: true
                  ],
                  route_white_list: %{
                    :default => [
                      "/asset_assignment",
                      "/location_assignment",
                      "/asset_overview",
                      "/mine_map",
                      "/operators",
                      "/asset_roster",
                      "/device_assignment",
                      "/asset_status",
                      "/engine_hours",
                      "/time_allocation",
                      "/operator_time_allocation",
                      "/time_allocation_report",
                      "/pre_start_submissions"
                    ],
                    "0a91f791-d521-4ac4-a35e-8cc509c02cb7" => [
                      "/asset_assignment",
                      "/location_assignment",
                      "/mine_map",
                      "/asset_progress_line",
                      "/operators",
                      "/asset_roster",
                      "/device_assignment",
                      "/asset_status",
                      "/time_allocation",
                      "/operator_time_allocation",
                      "/time_allocation_report",
                      "/time_code_editor",
                      "/message_editor",
                      "/engine_hours",
                      "/debug",
                      "/agents",
                      "/route_map",
                      "/pre_start_editor",
                      "/pre_start_submissions",
                      "/asset_overview"
                    ]
                  },
                  map_center: %{
                    latitude: -32.969483,
                    longitude: 116.079195,
                    zoom: 15
                  },
                  map_tile_endpoint: "https://hxtest.blob.core.windows.net/alcoa-wdl-map-tiles"
                ]
            - name: URL
              value: https://alcoa-wdl-test.haultrax.digital